"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function displayValue(e,t){if(!t)return"";switch(e.type){case"location":return t.district+", "+t.municipality+", "+t.village;default:return t.toString()}}function TimePeriodState(e){return{periodStart:e.periodStart,periodEnd:e.periodEnd}}function TimePeriodDispatch(e){return{onPeriodChanged:function(t,a){e({type:"changePeriod",field:t,value:a})}}}function AggregationsPanelState(e){return{aggregations:e.aggregations}}function AggregationsPanelDispatch(e){return{onAggregationChanged:function(t,a){e({type:"changeAggregation",index:t,by:a})},onAggregationAdded:function(t){e({type:"addAggregation",by:t})}}}function AggregationsTableState(e){return{rows:e.aggregatedData}}function fetchDataSource(e){if(!e)return{type:"loadDataSource",dataSource:e,data:null};var t=function(){var t=DataSources[e];return{v:function(a){return fetch(t.url).then(function(e){return e.json()}).then(function(t){var n=_.sortBy(t,"date");a({type:"loadDataSource",dataSource:e,data:n})})}}}();return"object"===("undefined"==typeof t?"undefined":_typeof(t))?t.v:void 0}function fetchCities(){return function(e){return fetch("data/cities.json").then(function(e){return e.json()}).then(function(t){e({type:"loadCities",data:_.sortBy(t,_.identity)})})}}function filterRows(e,t){return _.filter(t,function(t){if(e.periodStart&&t.date<e.periodStart)return!1;if(e.periodEnd&&t.date>e.periodEnd)return!1;if(void 0!=e.location){var a=e.locations[e.location].toLocaleLowerCase().slice(0,3);if(!t.location)return!1;if(a!=t.location.district.toLocaleLowerCase().slice(0,3))return!1}return!0})}function getBucket(e,t){switch(t){case"year":if(e.date){var a=e.date.slice(0,4);return{key:a,label:a}}return null;case"district":if(e.location){var n=e.location.district;n=n[0].toLocaleUpperCase()+n.slice(1).toLocaleLowerCase();var r=n.slice(0,3).toLocaleLowerCase();return{key:r,label:n}}return null;default:return null}}function aggregateRows(e,t){if(e.aggregations.length<=0)return[];var a={};return _.each(t,function(t){var n=getBucket(t,e.aggregations[0]);if(null!=n){var r=a[n.key]||{count:0,label:n.label};r.count++,a[n.key]=r}}),a}var DataSources={cchf:{label:"CCHF",url:"data/cchf.json",fields:[{name:"date",label:"Date of onset",type:"date"},{name:"location",label:"Location",type:"location"},{name:"age",label:"Age",type:"number"},{name:"gender",label:"Gender",type:"enumeration"},{name:"case_contact",label:"Case type",type:"enumeration"},{name:"date_hospitalization_district",label:"Date of hospitalization in district",type:"date"},{name:"date_hospitalization_central",label:"Date of hospitalization in central",type:"date"},{name:"district_reporting_date",label:"Date of reporting for district",type:"date"},{name:"iph_reporting_date",label:"Date of reporting for IPH",type:"date"},{name:"patient_status",label:"Patient status",type:"enumeration"},{name:"epi_investigation_date",label:"EPI investigation",type:"date"}]},brucellosis:{label:"Brucellosis",url:"data/brucellosis.json",fields:[{name:"date",label:"Date of onset",type:"date"},{name:"location",label:"Location",type:"location"},{name:"age",label:"Age",type:"number"},{name:"gender",label:"Gender",type:"enumeration"},{name:"case_contact",label:"Case type",type:"enumeration"},{name:"date_hospitalization_district",label:"Date of hospitalization in district",type:"date"},{name:"date_hospitalization_central",label:"Date of hospitalization in central",type:"date"}]}},AggregationTypes=["Year","District"],_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),connect=ReactRedux.connect,DataSourceSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleSelect",value:function(e){this.props.onSelected(e&&e.value)}},{key:"render",value:function(){var e=_.map(DataSources,function(e,t){return{value:t,label:e.label}});return React.createElement("div",{className:""},React.createElement("label",null,"Data Source"),React.createElement(Select,{value:this.props.dataSource,onChange:this.handleSelect.bind(this),options:e}))}}]),t}(React.Component),LocationSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleSelect",value:function(e){this.props.onSelected(e&&e.value)}},{key:"render",value:function(){var e=_.map(this.props.locations,function(e,t){return{value:t,label:e}});return React.createElement("div",{className:""},React.createElement("label",null,"Location"),React.createElement(Select,{value:this.props.location,onChange:this.handleSelect.bind(this),options:e}))}}]),t}(React.Component),TimePeriodSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e,t){this.props.onPeriodChanged(e,t.target.value)}},{key:"render",value:function(){return React.createElement("div",{className:""},React.createElement("label",null,"Time Period"),React.createElement("input",{className:"form-control",value:this.props.periodStart||"",onChange:this.handleChange.bind(this,"periodStart")}),React.createElement("input",{className:"form-control",value:this.props.periodEnd||"",onChange:this.handleChange.bind(this,"periodEnd")}))}}]),t}(React.Component),FilterRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("div",{className:"form-inline filter-row"},React.createElement("label",null,"Filter #",this.props.name),React.createElement("input",{className:"form-control"}),React.createElement("button",{className:"btn btn-danger",onClick:this.props.onRemove},"Remove filter"))}}]),t}(React.Component),FiltersPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleNewFilter",value:function(){this.props.addFilter()}},{key:"handleRemoveFilter",value:function(e){this.props.removeFilter(e)}},{key:"render",value:function(){var e=_.map(this.props.filters,function(e,t){return React.createElement(FilterRow,{key:t,name:e,onRemove:this.handleRemoveFilter.bind(this,t)})}.bind(this));return React.createElement("div",{className:"additional-filters"},e,React.createElement("button",{className:"btn btn-primary",onClick:this.handleNewFilter.bind(this)},"Add filter"))}}]),t}(React.Component),AggregationRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e){this.props.onChange(e&&e.value)}},{key:"render",value:function(){var e=_.map(AggregationTypes,function(e){return{value:e.toLocaleLowerCase(),label:e}});return React.createElement("div",{"class":"row form-inline aggregation-row"},React.createElement("label",{"for":"agg1"},"Aggregate by"),React.createElement(Select,{clearable:!!this.props.clearable,value:this.props.by,options:e,onChange:this.handleChange.bind(this)}))}}]),t}(React.Component),AggregationsPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e,t){this.props.onAggregationChanged(e,t)}},{key:"handleAdd",value:function(e){this.props.onAggregationAdded(e)}},{key:"render",value:function(){var e=this.props.aggregations.length,t=_.map(this.props.aggregations,function(t,a){return React.createElement(AggregationRow,{by:t,key:a,onChange:this.handleChange.bind(this,a),clearable:e>1})}.bind(this));return React.createElement("div",{className:"col-md-12"},React.createElement("fieldset",null,React.createElement("legend",null,"Aggregations"),t,React.createElement(AggregationRow,{key:"new",onChange:this.handleAdd.bind(this),clearable:!0})))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),connect=ReactRedux.connect,FilterTableRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=void 0;return e=_.map(this.props.fields,function(e){var t=this.props.data[e.name];return t=displayValue(e,t),React.createElement("td",{key:e.name},t)}.bind(this)),React.createElement("tr",null,e)}}]),t}(React.Component),FilterTable=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this,t=void 0,a=void 0;this.props.rows&&!function(){var n=e.props.dataSource.fields;t=_.map(e.props.rows,function(e,t){return React.createElement(FilterTableRow,{data:e,fields:n,key:t})}),a=_.map(n,function(e){return React.createElement("th",{key:e.name},e.label)})}();var n=this.props.rows.length,r=this.props.totalCount;return React.createElement("div",{className:"col-md-12"},React.createElement("p",{className:"fineprint"},"Showing ",n," of ",r," records."),React.createElement("table",{className:"table filter-results"},React.createElement("thead",null,React.createElement("tr",null,a)),React.createElement("tbody",null,t)))}}]),t}(React.Component),AggregationsTable=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=void 0;return this.props.rows&&(e=_.map(this.props.rows,function(e,t){return React.createElement("tr",{key:t},React.createElement("td",null,e.label),React.createElement("td",null,e.count))})),React.createElement("table",{className:"table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Group"),React.createElement("th",null,"No. of cases"))),React.createElement("tbody",null,e))}}]),t}(React.Component),QueryPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=void 0,t=void 0,a=void 0,n=void 0;return this.props.hasDataSource&&(e=React.createElement(FiltersPanel,null),a=React.createElement(AggregationsPanel,null),this.props.hasData&&(t=React.createElement(FilterTable,null),n=React.createElement(AggregationsTable,null))),React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-3"},React.createElement("legend",null,"Filters"),React.createElement(TimePeriodSection,null),React.createElement(LocationSection,null),React.createElement(DataSourceSection,null),e),React.createElement("div",{className:"col-md-9"},t)),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-3"},a),React.createElement("div",{className:"col-md-9"},n)))}}]),t}(React.Component),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},initialState={locations:[],originalData:[],periodStart:null,periodEnd:null,location:null,dataSource:null,nextFilterId:3,filters:[],aggregations:["year"],filteredData:[],aggregatedData:[]},createStore=Redux.createStore,applyMiddleware=Redux.applyMiddleware,Provider=ReactRedux.Provider,connect=ReactRedux.connect,thunk=ReduxThunk["default"];TimePeriodSection=connect(TimePeriodState,TimePeriodDispatch)(TimePeriodSection);var DataSourceSectionState=function(e){return{dataSource:e.dataSource}},DataSourceSectionDispatch=function(e){return{onSelected:function(t){e(fetchDataSource(t))}}};DataSourceSection=connect(DataSourceSectionState,DataSourceSectionDispatch)(DataSourceSection);var LocationSectionState=function(e){return{location:e.location,locations:e.locations}},LocationSectionDispatch=function(e){return{onSelected:function(t){e({type:"selectLocation",location:t})}}};LocationSection=connect(LocationSectionState,LocationSectionDispatch)(LocationSection);var FiltersPanelState=function(e){return{filters:e.filters}},FiltersPanelDispatch=function(e){return{addFilter:function(){e({type:"addFilter"})},removeFilter:function(t){e({type:"removeFilter",index:t})}}};FiltersPanel=connect(FiltersPanelState,FiltersPanelDispatch)(FiltersPanel);var FilterTableState=function(e){return{rows:e.filteredData,dataSource:DataSources[e.dataSource],totalCount:e.originalData.length}};FilterTable=connect(FilterTableState)(FilterTable),AggregationsPanel=connect(AggregationsPanelState,AggregationsPanelDispatch)(AggregationsPanel),AggregationsTable=connect(AggregationsTableState)(AggregationsTable);var QueryPanelState=function(e){return{hasDataSource:null!=e.dataSource,hasData:e.originalData&&e.originalData.length>0}};QueryPanel=connect(QueryPanelState)(QueryPanel);var reducer=function(e,t){if(void 0===e)return initialState;var a=e,n=void 0,r=void 0;switch(t.type){case"changePeriod":a="periodStart"==t.field?Object.assign({},e,{periodStart:t.value}):Object.assign({},e,{periodEnd:t.value});break;case"selectLocation":a=Object.assign({},e,{location:t.location});break;case"selectDataSource":a=Object.assign({},e,{dataSource:t.dataSource});break;case"addFilter":var o=e.nextFilterId;n=e.filters.concat([o]),a=Object.assign({},e,{filters:n,nextFilterId:o+1});break;case"removeFilter":n=e.filters.concat([]),n.splice(t.index,1),a=Object.assign({},e,{filters:n});break;case"loadDataSource":a=Object.assign({},e,{dataSource:t.dataSource,originalData:t.data});break;case"loadCities":a=Object.assign({},e,{locations:t.data});break;case"changeAggregation":r=e.aggregations.concat([]),t.by?r[t.index]=t.by:r.splice(t.index,1),a=Object.assign({},e,{aggregations:r});break;case"addAggregation":r=e.aggregations.concat([t.by]),a=Object.assign({},e,{aggregations:r})}var i=filterRows(a,a.originalData);a=Object.assign({},a,{filteredData:i});var l=aggregateRows(a,i);return a=Object.assign({},a,{aggregatedData:l})},store=createStore(reducer,applyMiddleware(thunk));store.dispatch(fetchCities()),store.dispatch(fetchDataSource("cchf")),ReactDOM.render(React.createElement(Provider,{store:store},React.createElement(QueryPanel,null)),document.getElementById("app"));