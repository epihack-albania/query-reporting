"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function displayValue(e,t){if(!t)return"";switch(e.type){case"location":return t.district+", "+t.municipality+", "+t.village;default:return t.toString()}}function TimePeriodState(e){return{periodStart:e.periodStart,periodEnd:e.periodEnd}}function TimePeriodDispatch(e){return{onPeriodChanged:function(t,a){e({type:"changePeriod",field:t,value:a})}}}function AggregationsPanelState(e){return{aggregations:e.aggregations}}function AggregationsPanelDispatch(e){return{onAggregationChanged:function(t,a){e({type:"changeAggregation",index:t,by:a})},onAggregationAdded:function(t){e({type:"addAggregation",by:t})}}}function AggregationsTableState(e){return{data:e.aggregatedData}}function fetchDataSource(e){if(!e)return{type:"loadDataSource",dataSource:e,data:null};var t=function(){var t=DataSources[e];return{v:function(a){return fetch(t.url).then(function(e){return e.json()}).then(function(t){var n=_.sortBy(t,"date");a({type:"loadDataSource",dataSource:e,data:n})})}}}();return"object"===("undefined"==typeof t?"undefined":_typeof(t))?t.v:void 0}function fetchCities(){return function(e){return fetch("data/cities.json").then(function(e){return e.json()}).then(function(t){e({type:"loadCities",data:_.sortBy(t,_.identity)})})}}function filterApplies(e,t){var a=t[e.name];switch(e.type){case"number":if(e.from&&parseInt(a)<parseInt(e.from))return!1;if(e.to&&parseInt(a)>parseInt(e.to))return!1;break;case"date":if(e.from&&a<e.from)return!1;if(e.to&&a>e.to)return!1;break;case"enumeration":if(e.options.length>0)return _.includes(e.options,a)}return!0}function filterRows(e,t){return _.filter(t,function(t){if(e.periodStart&&t.date<e.periodStart)return!1;if(e.periodEnd&&t.date>e.periodEnd)return!1;if(void 0!=e.location){var a=e.locations[e.location].toLocaleLowerCase().slice(0,3);if(!t.location)return!1;if(a!=t.location.district.toLocaleLowerCase().slice(0,3))return!1}return _.every(e.filters,function(e){return filterApplies(e,t)})})}function getGroup(e,t){switch(t){case"year":if(e.date){var a=e.date.slice(0,4);return{key:a,label:a}}return null;case"district":if(e.location){var n=e.location.district;n=n[0].toLocaleUpperCase()+n.slice(1).toLocaleLowerCase();var r=n.slice(0,3).toLocaleLowerCase();return{key:r,label:n}}return null;case"gender":switch(e.gender){case"M":return{key:"M",label:"Male"};case"F":return{key:"F",label:"Female"};case"U":return{key:"U",label:"Unknown"};default:return null}case"age":if(void 0==e.age)return null;var o=parseInt(e.age);return 1>o?{key:"00-01",label:"0 years"}:4>=o?{key:"01-04",label:"1-4 years"}:9>=o?{key:"05-09",label:"5-9 years"}:14>=o?{key:"10-14",label:"10-14 years"}:19>=o?{key:"15-19",label:"15-19 years"}:24>=o?{key:"20-24",label:"20-24 years"}:29>=o?{key:"25-29",label:"25-29 years"}:34>=o?{key:"30-34",label:"30-34 years"}:39>=o?{key:"35-39",label:"35-39 years"}:44>=o?{key:"40-44",label:"40-44 years"}:49>=o?{key:"45-49",label:"45-49 years"}:54>=o?{key:"50-54",label:"50-54 years"}:59>=o?{key:"55-59",label:"55-59 years"}:64>=o?{key:"60-64",label:"60-64 years"}:69>=o?{key:"65-69",label:"65-69 years"}:74>=o?{key:"70-74",label:"70-74 years"}:79>=o?{key:"75-79",label:"75-79 years"}:84>=o?{key:"80-84",label:"80-84 years"}:{key:"85+",label:"85+ years"};default:return null}}function aggregateRows(e,t){function a(t,n,r){var o=e.aggregations[n];if(o){var i=getGroup(r,o);if(null!=i){var l=t[i.key]||{count:0,buckets:{}};l.count++,a(l.buckets,n+1,r),t[i.key]=l}}}if(e.aggregations.length<=0)return[];var n=_.map(e.aggregations,function(e){var a={};return _.each(t,function(t){var n=getGroup(t,e);n&&!a.hasOwnProperty(n.key)&&(a[n.key]={key:n.key,label:n.label})}),a=_.map(a,_.identity),_.sortBy(a,"key")}),r={};return _.each(t,function(e){a(r,0,e)}),{groups:n,data:r}}function getEnumOptions(e,t){var a={};return _.each(t,function(t){a[t[e]]=1}),_.keys(a)}var DataSources={cchf:{label:"CCHF",url:"data/cchf.json",fields:[{name:"date",label:"Date of onset",type:"date"},{name:"location",label:"Location",type:"location"},{name:"age",label:"Age",type:"number"},{name:"gender",label:"Gender",type:"enumeration"},{name:"case_contact",label:"Case type",type:"enumeration"},{name:"date_hospitalization_district",label:"Date of hospitalization in district",type:"date"},{name:"date_hospitalization_central",label:"Date of hospitalization in central",type:"date"},{name:"district_reporting_date",label:"Date of reporting for district",type:"date"},{name:"iph_reporting_date",label:"Date of reporting for IPH",type:"date"},{name:"patient_status",label:"Patient status",type:"enumeration"},{name:"epi_investigation_date",label:"EPI investigation",type:"date"}]},brucellosis:{label:"Brucellosis",url:"data/brucellosis.json",fields:[{name:"date",label:"Date of onset",type:"date"},{name:"location",label:"Location",type:"location"},{name:"age",label:"Age",type:"number"},{name:"gender",label:"Gender",type:"enumeration"},{name:"case_contact",label:"Case type",type:"enumeration"},{name:"date_hospitalization_district",label:"Date of hospitalization in district",type:"date"},{name:"date_hospitalization_central",label:"Date of hospitalization in central",type:"date"}]}},AggregationTypes=["Year","District","Age","Gender"],_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),connect=ReactRedux.connect,DataSourceSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleSelect",value:function(e){this.props.onSelected(e&&e.value)}},{key:"render",value:function(){var e=_.map(DataSources,function(e,t){return{value:t,label:e.label}});return React.createElement("div",{className:""},React.createElement("label",null,"Data Source"),React.createElement(Select,{value:this.props.dataSource,onChange:this.handleSelect.bind(this),options:e}))}}]),t}(React.Component),LocationSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleSelect",value:function(e){this.props.onSelected(e&&e.value)}},{key:"render",value:function(){var e=_.map(this.props.locations,function(e,t){return{value:t,label:e}});return React.createElement("div",{className:""},React.createElement("label",null,"Location"),React.createElement(Select,{value:this.props.location,onChange:this.handleSelect.bind(this),options:e}))}}]),t}(React.Component),TimePeriodSection=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e,t){this.props.onPeriodChanged(e,t.target.value)}},{key:"render",value:function(){return React.createElement("div",{className:""},React.createElement("label",null,"Time Period"),React.createElement("input",{className:"form-control",value:this.props.periodStart||"",onChange:this.handleChange.bind(this,"periodStart")}),React.createElement("input",{className:"form-control",value:this.props.periodEnd||"",onChange:this.handleChange.bind(this,"periodEnd")}))}}]),t}(React.Component),FilterRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e,t){this.props.onChange(e,t.target.value)}},{key:"handleSelectChange",value:function(e){this.props.onChange("options",_.map(e,"value"))}},{key:"render",value:function(){var e=void 0;switch(this.props.data.type){case"number":case"date":e=[React.createElement("input",{key:"from",value:this.props.data.from,onChange:this.handleChange.bind(this,"from")}),React.createElement("input",{key:"to",value:this.props.data.to,onChange:this.handleChange.bind(this,"to")})];break;case"enumeration":var t=_.map(this.props.data.enumOptions,function(e){return{value:e,label:e}});e=React.createElement(Select,{options:t,multi:!0,value:this.props.data.options,onChange:this.handleSelectChange.bind(this)})}return React.createElement("div",{className:"form-inline filter-row"},React.createElement("label",null,React.createElement("button",{className:"btn btn-danger btn-xs",onClick:this.props.onRemove},React.createElement("span",{className:"glyphicon glyphicon-remove"})),this.props.name),e)}}]),t}(React.Component),FiltersPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleNewFilter",value:function(e){this.props.addFilter(e.value)}},{key:"handleRemoveFilter",value:function(e){this.props.removeFilter(e)}},{key:"handleFilterChange",value:function(e,t,a){this.props.changeFilter(e,t,a)}},{key:"render",value:function(){var e=_.map(this.props.filters,function(e,t){return React.createElement(FilterRow,{key:t,name:e.label,data:e,onChange:this.handleFilterChange.bind(this,t),onRemove:this.handleRemoveFilter.bind(this,t)})}.bind(this)),t=_.filter(this.props.fields,function(e){return"date"!=e.name&&"location"!=e.name}),a=_.map(t,function(e,t){return{value:e.name,label:e.label}});return React.createElement("div",{className:"additional-filters"},e,React.createElement(Select,{className:"add-filter",options:a,placeholder:"Add new filter...",onChange:this.handleNewFilter.bind(this)}))}}]),t}(React.Component),AggregationRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e){this.props.onChange(e&&e.value)}},{key:"render",value:function(){var e=_.map(AggregationTypes,function(e){return{value:e.toLocaleLowerCase(),label:e}});return React.createElement("div",{"class":"row form-inline aggregation-row"},React.createElement(Select,{clearable:!!this.props.clearable,value:this.props.by,options:e,onChange:this.handleChange.bind(this)}))}}]),t}(React.Component),AggregationsPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"handleChange",value:function(e,t){this.props.onAggregationChanged(e,t)}},{key:"handleAdd",value:function(e){this.props.onAggregationAdded(e)}},{key:"render",value:function(){var e=this.props.aggregations.length,t=_.map(this.props.aggregations,function(t,a){return React.createElement(AggregationRow,{by:t,key:a,onChange:this.handleChange.bind(this,a),clearable:e>1})}.bind(this));return t.length<3&&t.push(React.createElement(AggregationRow,{key:"new",onChange:this.handleAdd.bind(this),clearable:!0})),React.createElement("div",{className:"col-md-12"},React.createElement("fieldset",null,React.createElement("legend",null,"Aggregations"),React.createElement("p",null,"Group records by"),t))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),connect=ReactRedux.connect,FilterTableRow=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=void 0;return e=_.map(this.props.fields,function(e){var t=this.props.data[e.name];return t=displayValue(e,t),React.createElement("td",{key:e.name},t)}.bind(this)),React.createElement("tr",null,e)}}]),t}(React.Component),FilterTable=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this,t=void 0,a=void 0;this.props.rows&&!function(){var n=e.props.dataSource.fields;t=_.map(e.props.rows,function(e,t){return React.createElement(FilterTableRow,{data:e,fields:n,key:t})}),a=_.map(n,function(e){return React.createElement("th",{key:e.name},e.label)})}();var n=this.props.rows.length,r=this.props.totalCount;return React.createElement("div",{className:"col-md-12"},React.createElement("p",null,"Showing ",n," of ",r," records.",React.createElement("a",{href:"#",className:"export"},React.createElement("span",{className:"glyphicon glyphicon-save"})," Export to CSV")),React.createElement("table",{className:"table filter-results"},React.createElement("thead",null,React.createElement("tr",null,a)),React.createElement("tbody",null,t)))}}]),t}(React.Component),AggregationsTable=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){if(!this.props.data)return React.createElement("div",null);switch(this.props.data.groups.length){case 1:return this.renderOneDimension();case 2:return this.renderTwoDimensions();default:return this.renderThreeDimensions()}}},{key:"renderOneDimension",value:function(){var e=this.props.data.data,t=_.map(this.props.data.groups[0],function(t){return React.createElement("tr",{key:t.key},React.createElement("td",null,t.label),React.createElement("td",null,e[t.key].count))});return React.createElement("table",{className:"table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Group"),React.createElement("th",null,"No. of cases"))),React.createElement("tbody",null,t))}},{key:"renderTwoDimensions",value:function(){var e=this.props.data.data,t=this.props.data.groups,a=_.map(t[0],function(e){return React.createElement("th",{key:e.key},e.label)}),n=_.map(t[1],function(a){var n=_.map(t[0],function(t){var n=e[t.key],r=n.buckets[a.key];return React.createElement("td",{key:t.key},r?r.count:0)});return React.createElement("tr",{key:a.key},React.createElement("td",null,a.label),n)});return React.createElement("table",{className:"table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null),a)),React.createElement("tbody",null,n))}},{key:"renderThreeDimensions",value:function(){var e=this.props.data.data,t=this.props.data.groups,a=_.map(t[0],function(e){var a=_.map(t[1],function(t){return React.createElement("th",{key:e.key+"-"+t.key},t.label)});return[React.createElement("th",{colSpan:t[1].length,key:e.key},e.label),a]}),n=_.map(a,_.head),r=_.flattenDeep(_.map(a,_.tail)),o=_.map(t[2],function(a){var n=_.map(t[0],function(n){var r=_.map(t[1],function(t){var r=e[n.key],o=r.buckets[t.key]||{buckets:{}},i=o.buckets[a.key]||{count:0};return React.createElement("td",{key:n.key+"-"+t.key},i.count)});return r});return React.createElement("tr",{key:a.key},React.createElement("td",null,a.label),_.flattenDeep(n))});return React.createElement("table",{className:"table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{rowSpan:"2"}),n),React.createElement("tr",null,r)),React.createElement("tbody",null,o))}}]),t}(React.Component),QueryPanel=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=void 0,t=void 0,a=void 0,n=void 0;return this.props.hasDataSource&&(e=React.createElement(FiltersPanel,null),a=React.createElement(AggregationsPanel,null),this.props.hasData&&(t=React.createElement(FilterTable,null),n=React.createElement(AggregationsTable,null))),React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-3"},React.createElement("legend",null,"Filters"),React.createElement(TimePeriodSection,null),React.createElement(LocationSection,null),React.createElement(DataSourceSection,null),e),React.createElement("div",{className:"col-md-9 table-container"},t)),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-3"},a),React.createElement("div",{className:"col-md-9 table-container"},n)))}}]),t}(React.Component),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},initialState={locations:[],originalData:[],periodStart:null,periodEnd:null,location:null,dataSource:null,filters:[],aggregations:["year"],filteredData:[],aggregatedData:[]},createStore=Redux.createStore,applyMiddleware=Redux.applyMiddleware,Provider=ReactRedux.Provider,connect=ReactRedux.connect,thunk=ReduxThunk["default"];TimePeriodSection=connect(TimePeriodState,TimePeriodDispatch)(TimePeriodSection);var DataSourceSectionState=function(e){return{dataSource:e.dataSource}},DataSourceSectionDispatch=function(e){return{onSelected:function(t){e(fetchDataSource(t))}}};DataSourceSection=connect(DataSourceSectionState,DataSourceSectionDispatch)(DataSourceSection);var LocationSectionState=function(e){return{location:e.location,locations:e.locations}},LocationSectionDispatch=function(e){return{onSelected:function(t){e({type:"selectLocation",location:t})}}};LocationSection=connect(LocationSectionState,LocationSectionDispatch)(LocationSection);var FiltersPanelState=function(e){return{filters:e.filters,fields:DataSources[e.dataSource].fields}},FiltersPanelDispatch=function(e){return{addFilter:function(t){e({type:"addFilter",name:t})},removeFilter:function(t){e({type:"removeFilter",index:t})},changeFilter:function(t,a,n){e({type:"changeFilter",index:t,field:a,value:n})}}};FiltersPanel=connect(FiltersPanelState,FiltersPanelDispatch)(FiltersPanel);var FilterTableState=function(e){return{rows:e.filteredData,dataSource:DataSources[e.dataSource],totalCount:e.originalData.length}};FilterTable=connect(FilterTableState)(FilterTable),AggregationsPanel=connect(AggregationsPanelState,AggregationsPanelDispatch)(AggregationsPanel),AggregationsTable=connect(AggregationsTableState)(AggregationsTable);var QueryPanelState=function(e){return{hasDataSource:null!=e.dataSource,hasData:e.originalData&&e.originalData.length>0}};QueryPanel=connect(QueryPanelState)(QueryPanel);var reducer=function(e,t){if(void 0===e)return initialState;var a=e,n=void 0,r=void 0;switch(t.type){case"changePeriod":a="periodStart"==t.field?Object.assign({},e,{periodStart:t.value}):Object.assign({},e,{periodEnd:t.value});break;case"selectLocation":a=Object.assign({},e,{location:t.location});break;case"selectDataSource":a=Object.assign({},e,{dataSource:t.dataSource});break;case"addFilter":var o=_.find(DataSources[e.dataSource].fields,["name",t.name]),i=void 0;"enumeration"==o.type&&(i=getEnumOptions(o.name,e.originalData)),n=e.filters.concat([_.extend({from:"",to:"",options:[],enumOptions:i},o)]),a=Object.assign({},e,{filters:n});break;case"removeFilter":n=e.filters.concat([]),n.splice(t.index,1),a=Object.assign({},e,{filters:n});break;case"changeFilter":n=e.filters.concat([]),n[t.index][t.field]=t.value,a=Object.assign({},e,{filters:n});break;case"loadDataSource":a=Object.assign({},e,{dataSource:t.dataSource,originalData:t.data});break;case"loadCities":a=Object.assign({},e,{locations:t.data});break;case"changeAggregation":r=e.aggregations.concat([]),t.by?r[t.index]=t.by:r.splice(t.index,1),a=Object.assign({},e,{aggregations:r});break;case"addAggregation":r=e.aggregations.concat([t.by]),a=Object.assign({},e,{aggregations:r})}var l=filterRows(a,a.originalData);a=Object.assign({},a,{filteredData:l});var c=aggregateRows(a,l);return a=Object.assign({},a,{aggregatedData:c})},store=createStore(reducer,applyMiddleware(thunk));store.dispatch(fetchCities()),store.dispatch(fetchDataSource("cchf")),ReactDOM.render(React.createElement(Provider,{store:store},React.createElement(QueryPanel,null)),document.getElementById("app")),$(document).ready(function(){function e(e,t){var a=e.find("tr:has(td)"),n=String.fromCharCode(11),r=String.fromCharCode(0),o='","',i='"\r\n"',l='"'+a.map(function(e,t){var a=$(t),r=a.find("td");return r.map(function(e,t){var a=$(t),n=a.text();return n.replace(/"/g,'""')}).get().join(n)}).get().join(r).split(r).join(i).split(n).join(o)+'"',c="data:application/csv;charset=utf-8,"+encodeURIComponent(l);$(this).attr({download:t,href:c,target:"_blank"})}$("body").on("click",".export",function(t){e.apply(this,[$("table.filter-results"),"export.csv"])})});